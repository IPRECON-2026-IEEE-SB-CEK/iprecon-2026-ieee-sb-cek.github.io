<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IPRECON 2026 - Admin Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background: linear-gradient(135deg, #8e24aa, #211021);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
      }

      /* Login Screen Styles */
      .login-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .login-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, #8e24aa, #d4af37);
      }

      .login-header {
        margin-bottom: 30px;
      }

      .login-logo {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #8e24aa, #211021);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 2rem;
      }

      .login-title {
        font-size: 1.8rem;
        color: #211021;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .login-subtitle {
        color: #6c757d;
        font-size: 1rem;
      }

      .login-form {
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        font-family: inherit;
      }

      .form-group input:focus {
        outline: none;
        border-color: #8e24aa;
        box-shadow: 0 0 0 3px rgba(142, 36, 170, 0.1);
      }

      .login-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #8e24aa, #211021);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .login-btn:hover {
        background: linear-gradient(135deg, #7b1f96, #1a0e1a);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(142, 36, 170, 0.3);
      }

      .login-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 4px solid #dc3545;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      /* Admin Interface Styles */
      .admin-interface {
        display: none;
        max-width: 1200px;
        width: 90%;
        margin: 20px auto;
        padding: 20px;
      }

      .admin-interface.show {
        display: block;
      }

      .admin-header {
        background: white;
        color: #211021;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .admin-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, #8e24aa, #d4af37);
      }

      .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .admin-header p {
        opacity: 0.8;
        font-size: 1.1rem;
        margin-bottom: 5px;
      }

      .session-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 0.9rem;
        color: #6c757d;
      }

      .logout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .admin-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .admin-card:hover {
        border-color: #8e24aa;
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
      }

      .card-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #8e24aa, #211021);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
      }

      .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #211021;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        font-family: inherit;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #8e24aa;
        box-shadow: 0 0 0 3px rgba(142, 36, 170, 0.1);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 25px;
        background: linear-gradient(135deg, #8e24aa, #211021);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        font-family: inherit;
      }

      .btn:hover {
        background: linear-gradient(135deg, #7b1f96, #1a0e1a);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(142, 36, 170, 0.3);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn.success {
        background: #28a745;
      }

      .btn.success:hover {
        background: #218838;
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        background: #5a6268;
      }

      .status-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }

      .status-display.show {
        display: block;
      }

      .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid;
        font-weight: 500;
      }

      .alert.success {
        background: #d4edda;
        color: #155724;
        border-left-color: #28a745;
      }

      .alert.error {
        background: #f8d7da;
        color: #721c24;
        border-left-color: #dc3545;
      }

      .alert.info {
        background: #d1ecf1;
        color: #0c5460;
        border-left-color: #17a2b8;
      }

      .required {
        color: #dc3545;
      }

      .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .admin-grid {
          grid-template-columns: 1fr;
        }

        .admin-header {
          padding: 20px;
        }

        .admin-header h1 {
          font-size: 2rem;
          flex-direction: column;
          gap: 10px;
        }

        .admin-card {
          padding: 20px;
        }

        .logout-btn {
          position: static;
          margin-top: 15px;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
      <div class="login-header">
        <div class="login-logo">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h2 class="login-title">IPRECON 2026</h2>
        <p class="login-subtitle">Admin Email Management System</p>
      </div>

      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label for="adminPassword">Admin Password</label>
          <input
            type="password"
            id="adminPassword"
            placeholder="Enter admin password"
            required
          />
        </div>

        <button type="submit" class="login-btn" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i>
          <span>Secure Login</span>
        </button>
      </form>

      <div class="error-message" id="loginError"></div>
    </div>

    <!-- Admin Interface -->
    <div class="admin-interface" id="adminInterface">
      <div class="admin-header">
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        <h1><i class="fas fa-envelope"></i> IPRECON 2026</h1>
        <p>Email Subscription Management System</p>
        <div class="session-info" id="sessionInfo">
          <i class="fas fa-clock"></i> Session active
        </div>
      </div>

      <div class="admin-grid">
        <!-- Send Page Live Notification -->
        <div class="admin-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-rocket"></i>
            </div>
            <h3 class="card-title">Send "Page is Live" Notifications</h3>
          </div>

          <form id="pageLiveForm">
            <div class="form-group">
              <label for="pageName"
                >Page Name <span class="required">*</span></label
              >
              <input
                type="text"
                id="pageName"
                placeholder="e.g., call-for-papers, registration"
                required
              />
              <div class="help-text">
                Must match the page name used in subscriptions
              </div>
            </div>

            <div class="form-group">
              <label for="pageUrl"
                >Page URL <span class="required">*</span></label
              >
              <input
                type="url"
                id="pageUrl"
                placeholder="https://iprecon.org/call-for-papers.html"
                required
              />
            </div>

            <div class="form-group">
              <label for="pageTitle">Page Title</label>
              <input type="text" id="pageTitle" placeholder="Call for Papers" />
              <div class="help-text">Friendly name for the page (optional)</div>
            </div>
            <div class="form-group">
              <label for="customContent">What Users Can Find (Optional)</label>
              <textarea
                id="customContent"
                rows="4"
                placeholder="Enter custom bullet points, one per line:&#10;Paper submission guidelines&#10;Important deadlines&#10;Review criteria"
              ></textarea>
              <div class="help-text">
                Leave blank to use default content for this page type
              </div>
            </div>

            <button type="submit" class="btn">
              <i class="fas fa-paper-plane"></i>
              Send Notifications
            </button>
          </form>

          <div id="pageLiveStatus" class="status-display"></div>
        </div>

        <!-- Test Email -->
        <div class="admin-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-flask"></i>
            </div>
            <h3 class="card-title">Test Email System</h3>
          </div>

          <form id="testEmailForm">
            <div class="form-group">
              <label for="testEmail"
                >Test Email Address <span class="required">*</span></label
              >
              <input
                type="email"
                id="testEmail"
                placeholder="test@example.com"
                required
              />
            </div>

            <div class="form-group">
              <label for="emailType">Email Type</label>
              <select id="emailType">
                <option value="confirmation">Subscription Confirmation</option>
                <option value="live">Page Live Notification</option>
              </select>
            </div>

            <button type="submit" class="btn success">
              <i class="fas fa-envelope"></i>
              Send Test Email
            </button>
          </form>

          <div id="testEmailStatus" class="status-display"></div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <h3 class="card-title">Quick Actions</h3>
          </div>

          <div class="form-group">
            <button
              type="button"
              class="btn secondary"
              onclick="checkWorkerStatus()"
            >
              <i class="fas fa-heartbeat"></i>
              Check Worker Status
            </button>
            <div class="help-text">
              Test if your worker is responding correctly
            </div>
          </div>

          <div class="form-group">
            <button
              type="button"
              class="btn secondary"
              onclick="refreshStats()"
            >
              <i class="fas fa-sync"></i>
              Get System Statistics
            </button>
            <div class="help-text">Get latest email sending statistics</div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="admin-card">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <h3 class="card-title">System Statistics</h3>
          </div>

          <div id="statsContainer">
            <p>
              Statistics will be displayed here after login or after checking
              stats.
            </p>
          </div>

          <button type="button" class="btn secondary" onclick="refreshStats()">
            <i class="fas fa-sync"></i>
            Refresh Stats
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===================================
      // CONFIGURATION - UPDATE THIS VALUE
      // ===================================
      const WORKER_URL =
        "https://iprecon-email-collector.ieeesbcek2000.workers.dev"; // UPDATE THIS

      // ===================================
      // Authentication & Session Management
      // ===================================

      let authToken = "";
      let tokenExpiry = null;
      let isLoggedIn = false;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        setupEventListeners();
        checkExistingSession();
      });

      function setupEventListeners() {
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("pageLiveForm")
          .addEventListener("submit", handlePageLiveSubmission);
        document
          .getElementById("testEmailForm")
          .addEventListener("submit", handleTestEmailSubmission);
      }

      function checkExistingSession() {
        // Check if user has a valid session token
        const sessionData = localStorage.getItem("iprecon_admin_session");
        if (sessionData) {
          try {
            const { token, expires } = JSON.parse(sessionData);
            const now = new Date().getTime();

            if (new Date(expires).getTime() > now) {
              // Token hasn't expired, verify it's still valid
              verifyExistingToken(token);
            } else {
              // Token expired, remove it
              localStorage.removeItem("iprecon_admin_session");
            }
          } catch (e) {
            localStorage.removeItem("iprecon_admin_session");
          }
        }
      }

      async function verifyExistingToken(token) {
        try {
          const response = await fetch(`${WORKER_URL}/admin/verify`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ token }),
          });

          const data = await response.json();

          if (data.success && data.valid) {
            authToken = token;
            tokenExpiry = new Date(data.expires);
            showAdminInterface();
            updateSessionInfo();
          } else {
            localStorage.removeItem("iprecon_admin_session");
          }
        } catch (error) {
          console.error("Token verification failed:", error);
          localStorage.removeItem("iprecon_admin_session");
        }
      }

      async function handleLogin(e) {
        e.preventDefault();

        const password = document.getElementById("adminPassword").value.trim();
        const errorDiv = document.getElementById("loginError");

        if (!password) {
          showLoginError("Please enter a password");
          return;
        }

        setLoginLoading(true);
        errorDiv.classList.remove("show");

        try {
          const response = await fetch(`${WORKER_URL}/admin/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          const data = await response.json();

          if (data.success && data.token) {
            authToken = data.token;
            tokenExpiry = new Date(data.expires);

            // Store session data
            localStorage.setItem(
              "iprecon_admin_session",
              JSON.stringify({
                token: authToken,
                expires: data.expires,
              })
            );

            showAdminInterface();
            updateSessionInfo();
            showAlert(
              "success",
              "Login successful! Welcome to the admin dashboard."
            );
          } else {
            showLoginError(data.error || "Login failed");
          }
        } catch (error) {
          showLoginError("Connection error. Please check your worker URL.");
          console.error("Login error:", error);
        } finally {
          setLoginLoading(false);
        }
      }

      function showLoginError(message) {
        const errorDiv = document.getElementById("loginError");
        errorDiv.textContent = message;
        errorDiv.classList.add("show");
      }

      function setLoginLoading(isLoading) {
        const loginBtn = document.getElementById("loginBtn");
        const icon = loginBtn.querySelector("i");
        const text = loginBtn.querySelector("span");

        if (isLoading) {
          loginBtn.disabled = true;
          icon.className = "fas fa-spinner spinner";
          text.textContent = "Authenticating...";
        } else {
          loginBtn.disabled = false;
          icon.className = "fas fa-sign-in-alt";
          text.textContent = "Secure Login";
        }
      }

      function showAdminInterface() {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("adminInterface").classList.add("show");
        document.body.style.background = "#f8f9fa";
        isLoggedIn = true;
      }

      function updateSessionInfo() {
        const sessionInfo = document.getElementById("sessionInfo");
        if (tokenExpiry) {
          const timeLeft = tokenExpiry.getTime() - new Date().getTime();

          if (timeLeft > 0) {
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            const formattedTime = `${hours
              .toString()
              .padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            // Add color coding based on time remaining
            let color = "#28a745"; // Green for > 1 hour
            if (timeLeft < 30 * 60 * 1000) color = "#ffc107"; // Yellow for < 30 min
            if (timeLeft < 5 * 60 * 1000) color = "#dc3545"; // Red for < 5 min

            sessionInfo.innerHTML = `<i class="fas fa-clock"></i> Session expires in <span style="color: ${color}; font-weight: bold;">${formattedTime}</span>`;
          } else {
            sessionInfo.innerHTML = `<i class="fas fa-clock"></i> <span style="color: #dc3545;">Session expired</span>`;
          }
        }
      }

      function logout() {
        localStorage.removeItem("iprecon_admin_session");
        document.getElementById("loginScreen").style.display = "block";
        document.getElementById("adminInterface").classList.remove("show");
        document.body.style.background =
          "linear-gradient(135deg, #8e24aa, #211021)";
        document.getElementById("adminPassword").value = "";
        authToken = "";
        tokenExpiry = null;
        isLoggedIn = false;
      }

      // Authenticated API request helper
      async function makeAuthenticatedRequest(endpoint, options = {}) {
        if (!authToken) {
          throw new Error("Not authenticated");
        }

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`,
          ...options.headers,
        };

        const response = await fetch(`${WORKER_URL}${endpoint}`, {
          ...options,
          headers,
        });

        if (response.status === 401) {
          // Token expired or invalid
          logout();
          showAlert("error", "Session expired. Please login again.");
          throw new Error("Authentication expired");
        }

        return response;
      }

      async function handlePageLiveSubmission(e) {
        e.preventDefault();

        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById("pageLiveStatus");

        const pageName = document.getElementById("pageName").value.trim();
        const pageUrl = document.getElementById("pageUrl").value.trim();
        const pageTitle = document.getElementById("pageTitle").value.trim();
        const customContentText = document
          .getElementById("customContent")
          .value.trim();
        const customContent = customContentText
          ? customContentText.split("\n").filter((line) => line.trim())
          : null;

        if (!pageName || !pageUrl) {
          showAlert("error", "Please fill in required fields.");
          return;
        }

        setLoading(submitBtn, true);
        statusDiv.classList.add("show");
        statusDiv.textContent = "Sending notifications...";

        try {
          const response = await makeAuthenticatedRequest(
            "/admin/notify-live",
            {
              method: "POST",
              body: JSON.stringify({
                page: pageName,
                pageUrl: pageUrl,
                pageTitle: pageTitle,
                customContent: customContent,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            statusDiv.textContent = `✅ Success!\nNotifications sent to ${data.stats.successful} subscribers\nFailed: ${data.stats.failed}\nTotal: ${data.stats.total}`;
            showAlert(
              "success",
              `Notifications sent successfully to ${data.stats.successful} subscribers!`
            );
            updateNotificationStats(data.stats);
          } else {
            statusDiv.textContent = `❌ Error: ${data.error}`;
            showAlert("error", `Failed to send notifications: ${data.error}`);
          }
        } catch (error) {
          if (error.message !== "Authentication expired") {
            statusDiv.textContent = `❌ Network Error: ${error.message}`;
            showAlert("error", `Network error: ${error.message}`);
          }
        } finally {
          setLoading(submitBtn, false);
        }
      }

      async function handleTestEmailSubmission(e) {
        e.preventDefault();

        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById("testEmailStatus");

        const testEmail = document.getElementById("testEmail").value.trim();
        const emailType = document.getElementById("emailType").value;

        if (!testEmail) {
          showAlert("error", "Please enter a test email address.");
          return;
        }

        setLoading(submitBtn, true);
        statusDiv.classList.add("show");
        statusDiv.textContent = "Sending test email...";

        try {
          const response = await makeAuthenticatedRequest("/admin/test-email", {
            method: "POST",
            body: JSON.stringify({
              email: testEmail,
              type: emailType,
            }),
          });

          const data = await response.json();

          if (data.success) {
            statusDiv.textContent = `✅ Test email sent successfully to ${testEmail}`;
            showAlert("success", "Test email sent successfully!");
          } else {
            statusDiv.textContent = `❌ Error: ${data.error}`;
            showAlert("error", `Failed to send test email: ${data.error}`);
          }
        } catch (error) {
          if (error.message !== "Authentication expired") {
            statusDiv.textContent = `❌ Network Error: ${error.message}`;
            showAlert("error", `Network error: ${error.message}`);
          }
        } finally {
          setLoading(submitBtn, false);
        }
      }

      async function refreshStats() {
        try {
          const response = await makeAuthenticatedRequest("/admin/stats");
          const data = await response.json();

          if (data.success) {
            updateSystemStats(data.stats);
            showAlert("info", "System statistics refreshed successfully!");
          } else {
            showAlert("error", "Failed to get statistics");
          }
        } catch (error) {
          if (error.message !== "Authentication expired") {
            showAlert("error", `Failed to get statistics: ${error.message}`);
          }
        }
      }

      function setLoading(button, isLoading) {
        if (isLoading) {
          button.disabled = true;
          const icon = button.querySelector("i");
          if (icon) {
            icon.className = "fas fa-spinner spinner";
          }
          button.style.opacity = "0.7";
        } else {
          button.disabled = false;
          const icon = button.querySelector("i");
          if (icon) {
            // Restore original icon based on button context
            if (button.closest("#pageLiveForm")) {
              icon.className = "fas fa-paper-plane";
            } else if (button.closest("#testEmailForm")) {
              icon.className = "fas fa-envelope";
            }
          }
          button.style.opacity = "1";
        }
      }

      function showAlert(type, message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        const alert = document.createElement("div");
        alert.className = `alert ${type}`;
        alert.textContent = message;

        document
          .querySelector(".admin-interface")
          .insertBefore(alert, document.querySelector(".admin-grid"));

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 5000);
      }

      function updateNotificationStats(stats) {
        const statsContainer = document.getElementById("statsContainer");
        statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 20px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${
                          stats.successful
                        }</div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Successful</div>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">${
                          stats.failed
                        }</div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Failed</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #17a2b8;">${
                          stats.total
                        }</div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Total</div>
                    </div>
                </div>
                <div style="font-size: 0.9rem; color: #6c757d; text-align: center;">
                    Last notification campaign: ${new Date().toLocaleString()}
                </div>
            `;
      }

      function updateSystemStats(stats) {
        const statsContainer = document.getElementById("statsContainer");
        statsContainer.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #211021;">System Status</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${
                              stats.activeTokens
                            }</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Active Sessions</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            <div style="font-size: 1rem; font-weight: bold; color: #17a2b8;">Online</div>
                            <div style="font-size: 0.9rem; color: #6c757d;">Worker Status</div>
                        </div>
                    </div>
                </div>
                <div style="font-size: 0.85rem; color: #6c757d; text-align: center;">
                    Server Time: ${new Date(
                      stats.serverTime
                    ).toLocaleString()}<br>
                    Last refreshed: ${new Date().toLocaleString()}
                </div>
            `;
      }

      async function checkWorkerStatus() {
        try {
          // Test basic CORS response first
          const response = await fetch(`${WORKER_URL}/subscribe`, {
            method: "OPTIONS",
          });

          if (response.ok) {
            showAlert("success", "✅ Worker is responding correctly!");

            // If we're logged in, also check the authenticated endpoints
            if (isLoggedIn) {
              try {
                const statsResponse = await makeAuthenticatedRequest(
                  "/admin/stats"
                );
                if (statsResponse.ok) {
                  showAlert(
                    "success",
                    "✅ Worker and authentication are working perfectly!"
                  );
                }
              } catch (e) {
                showAlert(
                  "info",
                  "✅ Worker is responding, but authentication may need refresh"
                );
              }
            }
          } else {
            showAlert(
              "error",
              `❌ Worker responded with status: ${response.status}`
            );
          }
        } catch (error) {
          showAlert("error", `❌ Worker is not accessible: ${error.message}`);
        }
      }

      // Auto-refresh session info every minute
      setInterval(() => {
        if (isLoggedIn && tokenExpiry) {
          updateSessionInfo();

          // Check if token is about to expire (less than 5 minutes)
          const timeLeft =
            (tokenExpiry.getTime() - new Date().getTime()) / (1000 * 60);
          if (timeLeft < 5 && timeLeft > 0) {
            showAlert(
              "info",
              `⏰ Session will expire in ${Math.floor(timeLeft)} minutes`
            );
          } else if (timeLeft <= 0) {
            showAlert("error", "Session expired. Please login again.");
            logout();
          }
        }
      }, 1000); // Every minute

      // Auto-logout when token expires
      function scheduleAutoLogout() {
        if (tokenExpiry) {
          const timeUntilExpiry = tokenExpiry.getTime() - new Date().getTime();
          if (timeUntilExpiry > 0) {
            setTimeout(() => {
              if (isLoggedIn) {
                showAlert(
                  "error",
                  "Session expired automatically for security."
                );
                logout();
              }
            }, timeUntilExpiry);
          }
        }
      }

      // Call this after successful login
      function onSuccessfulLogin() {
        scheduleAutoLogout();
        updateSessionInfo();

        // Automatically get initial stats
        setTimeout(() => {
          refreshStats();
        }, 1000);
      }

      // Update the login success handler
      async function handleLoginSuccess(data) {
        authToken = data.token;
        tokenExpiry = new Date(data.expires);

        // Store session data
        localStorage.setItem(
          "iprecon_admin_session",
          JSON.stringify({
            token: authToken,
            expires: data.expires,
          })
        );

        showAdminInterface();
        onSuccessfulLogin();
        showAlert(
          "success",
          "Login successful! Welcome to the admin dashboard."
        );
      }

      // Update the handleLogin function to use the new success handler
      async function handleLogin(e) {
        e.preventDefault();

        const password = document.getElementById("adminPassword").value.trim();
        const errorDiv = document.getElementById("loginError");

        if (!password) {
          showLoginError("Please enter a password");
          return;
        }

        setLoginLoading(true);
        errorDiv.classList.remove("show");

        try {
          const response = await fetch(`${WORKER_URL}/admin/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          const data = await response.json();

          if (data.success && data.token) {
            await handleLoginSuccess(data);
          } else {
            showLoginError(data.error || "Login failed");
          }
        } catch (error) {
          showLoginError("Connection error. Please check your worker URL.");
          console.error("Login error:", error);
        } finally {
          setLoginLoading(false);
        }
      }

      // Update the verifyExistingToken function
      async function verifyExistingToken(token) {
        try {
          const response = await fetch(`${WORKER_URL}/admin/verify`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ token }),
          });

          const data = await response.json();

          if (data.success && data.valid) {
            authToken = token;
            tokenExpiry = new Date(data.expires);
            showAdminInterface();
            onSuccessfulLogin();
          } else {
            localStorage.removeItem("iprecon_admin_session");
          }
        } catch (error) {
          console.error("Token verification failed:", error);
          localStorage.removeItem("iprecon_admin_session");
        }
      }

      // Enhanced error handling for network issues
      window.addEventListener("online", function () {
        if (isLoggedIn) {
          showAlert("success", "Connection restored!");
        }
      });

      window.addEventListener("offline", function () {
        if (isLoggedIn) {
          showAlert("error", "Connection lost. Some features may not work.");
        }
      });

      // Prevent accidental page refresh when logged in
      window.addEventListener("beforeunload", function (e) {
        if (isLoggedIn) {
          e.preventDefault();
          e.returnValue =
            "Are you sure you want to leave? You will need to login again.";
          return e.returnValue;
        }
      });

      // Console welcome message for developers
      console.log(`
        🚀 IPRECON 2026 Admin Interface
        
        📧 Email Management System Ready
        🔐 Secure Authentication Active
        ⚡ Worker Status: Checking...
        
        Need help? Check the worker configuration at:
        ${WORKER_URL}
        `);
    </script>
  </body>
</html>
